<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <!-- Cấu hình Viewport quan trọng cho hiển thị trên di động/iframe -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <!-- --- KHẮC PHỤC LỖI NHÚNG (EMBED FIX) --- -->
    <!-- Cho phép nhúng trang web này vào bất kỳ đâu (Canva, PowerPoint, v.v.) -->
    <meta http-equiv="Content-Security-Policy" content="frame-ancestors *;">
    
    <title>Mô Hình Tinh Thể NaCl Tối Giản</title>

    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tải Three.js (Bản Global - không dùng Module để tránh lỗi CORS trong iFrame) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Tải OrbitControls (Phiên bản tương thích với biến toàn cục THREE) -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <style>
        /* Reset CSS để đảm bảo full màn hình trong khung nhúng */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* Ẩn thanh cuộn */
            background-color: #0d1117;
            font-family: 'Inter', sans-serif;
        }
        #container {
            width: 100%;
            height: 100%;
            display: block;
        }
        canvas {
            display: block; /* Loại bỏ khoảng trắng thừa của thẻ inline */
        }
    </style>
</head>
<body>

    <div id="container"></div>

    <!-- Script chính: Không dùng type="module" -->
    <script>
        // --- CẤU HÌNH ---
        const CONFIG = {
            LATTICE_SPACING: 5,
            ION_COUNT: 4,
            COLORS: {
                Na: 0x2563EB, // Xanh dương
                Cl: 0x10B981, // Xanh lá
                Bond: 0x9CA3AF, // Xám
                Background: 0x0d1117
            },
            RADIUS: {
                Na: 0.8,
                Cl: 1.2,
                Bond: 0.15
            }
        };

        // Biến toàn cục
        let scene, camera, renderer, controls;
        let container = document.getElementById('container');

        // Hàm khởi tạo
        function init() {
            // 1. Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(CONFIG.COLORS.Background);

            // 2. Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(30, 20, 30); // Góc nhìn từ trên cao xuống một chút

            // 3. Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio); // Giúp hình ảnh sắc nét trên màn hình Retina
            container.appendChild(renderer.domElement);

            // 4. Controls
            // Kiểm tra xem THREE.OrbitControls có tồn tại không (do tải script global)
            if (THREE.OrbitControls) {
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.autoRotate = true; // Tự động xoay nhẹ để tạo hiệu ứng động
                controls.autoRotateSpeed = 2.0;
            } else {
                console.warn("OrbitControls chưa được tải đúng cách.");
            }

            // 5. Ánh sáng
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 1);
            dirLight.position.set(10, 20, 10);
            scene.add(dirLight);
            
            const backLight = new THREE.DirectionalLight(0xffffff, 0.5);
            backLight.position.set(-10, -10, -10);
            scene.add(backLight);

            // 6. Tạo vật thể
            createStructure();

            // 7. Event Resize
            window.addEventListener('resize', onWindowResize, false);

            // 8. Bắt đầu loop
            animate();
        }

        function createStructure() {
            const group = new THREE.Group();
            const offset = -((CONFIG.ION_COUNT - 1) * CONFIG.LATTICE_SPACING) / 2;

            for (let x = 0; x < CONFIG.ION_COUNT; x++) {
                for (let y = 0; y < CONFIG.ION_COUNT; y++) {
                    for (let z = 0; z < CONFIG.ION_COUNT; z++) {
                        
                        const px = offset + x * CONFIG.LATTICE_SPACING;
                        const py = offset + y * CONFIG.LATTICE_SPACING;
                        const pz = offset + z * CONFIG.LATTICE_SPACING;

                        // Xác định loại Ion
                        const isSodium = (x + y + z) % 2 === 0;
                        const radius = isSodium ? CONFIG.RADIUS.Na : CONFIG.RADIUS.Cl;
                        const color = isSodium ? CONFIG.COLORS.Na : CONFIG.COLORS.Cl;

                        // Mesh Ion
                        const geometry = new THREE.SphereGeometry(radius, 32, 32);
                        const material = new THREE.MeshPhysicalMaterial({
                            color: color,
                            metalness: 0.1,
                            roughness: 0.2,
                            clearcoat: 0.8
                        });
                        const atom = new THREE.Mesh(geometry, material);
                        atom.position.set(px, py, pz);
                        group.add(atom);

                        // Tạo liên kết (Bonds)
                        if (x < CONFIG.ION_COUNT - 1) createBond(group, px, py, pz, px + CONFIG.LATTICE_SPACING, py, pz);
                        if (y < CONFIG.ION_COUNT - 1) createBond(group, px, py, pz, px, py + CONFIG.LATTICE_SPACING, pz);
                        if (z < CONFIG.ION_COUNT - 1) createBond(group, px, py, pz, px, py, pz + CONFIG.LATTICE_SPACING);
                    }
                }
            }
            scene.add(group);
        }

        function createBond(group, x1, y1, z1, x2, y2, z2) {
            const start = new THREE.Vector3(x1, y1, z1);
            const end = new THREE.Vector3(x2, y2, z2);
            const direction = new THREE.Vector3().subVectors(end, start);
            const length = direction.length();

            const geometry = new THREE.CylinderGeometry(CONFIG.RADIUS.Bond, CONFIG.RADIUS.Bond, length, 8);
            const material = new THREE.MeshStandardMaterial({ color: CONFIG.COLORS.Bond });
            const bond = new THREE.Mesh(geometry, material);

            const center = new THREE.Vector3().addVectors(start, end).multiplyScalar(0.5);
            bond.position.copy(center);
            
            // Xoay cylinder theo hướng vector
            bond.quaternion.setFromUnitVectors(new THREE.Vector3(0, 1, 0), direction.normalize());
            
            group.add(bond);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update();
            renderer.render(scene, camera);
        }

        // Khởi chạy
        init();
    </script>
</body>
</html>
